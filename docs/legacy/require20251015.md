# 認証・認可機能の実装状況と今後の要件 (2025-10-15)

## 目次
1. [Phase 1 実装済み機能](#phase-1-実装済み機能)
2. [現在の重大な問題](#現在の重大な問題)
3. [今後必要な実装（優先度順）](#今後必要な実装優先度順)
4. [技術的負債](#技術的負債)

---

## Phase 1 実装済み機能

### Domain層
- ✅ **UserEntity の拡充**
  - `username`, `email`, `is_active` フィールド追加
  - `is_active` のデフォルト値は `True`

- ✅ **ChatTreeEntity の所有権管理**
  - `owner_uuid` フィールド追加
  - `new_chat()` に `owner_uuid` パラメータ追加（必須）
  - `revert_chat()` に `owner_uuid` パラメータ追加（必須）
  - `is_owned_by()` メソッド追加（所有権判定）

### Application層
- ✅ **UserRepositoryポート定義**
  - `save()`, `find_by_uuid()`, `find_by_email()`, `find_by_username()`
  - **※実装はまだ存在しない（Infrastructure層未実装）**

- ✅ **VerifyChatAccessユースケース**
  - ユーザーの `is_active` チェック
  - チャット所有権チェック
  - **※定義されているが、既存のユースケースで使用されていない**

### 既存コードの修正
- ✅ `ChatInteraction.start_chat()` で `owner_uuid` を設定
- ✅ `ChatSelection.restart_chat()` で `owner_uuid` を復元
- ✅ `ChatSelection.get_chat_tree()` で `owner_uuid` を復元
- ✅ 統合テスト・開発用スクリプトの修正

---

## 現在の重大な問題

### 🚨 緊急度：高

#### 1. owner_uuid がDBに永続化されていない
**問題:**
- `ChatTreeDetail` テーブルに `owner_uuid` カラムが存在しない
- `ChatRepositoryImpl.ensure_chat_tree_detail()` で `owner_uuid` を保存していない
- チャット作成時に owner 情報が DB に保存されない

**影響:**
- データ不整合が発生している
- アプリケーション再起動後に所有者情報が失われる
- 複数ユーザー環境では致命的

**場所:**
- `backend/src/infrastructure/db/models.py` - `ChatTreeDetail` モデル
- `backend/src/interface_adapters/gateways/chat_repository.py` - `ensure_chat_tree_detail()`

#### 2. ChatSelection が owner_uuid を誤った方法で設定している
**問題:**
```python
# 現在の実装（間違い）
chat_tree.owner_uuid = self.user.uuid  # DBから取得すべき

# 正しい実装
chat_tree.owner_uuid = chat_info.owner_uuid  # DBから取得した値を使用
```

**影響:**
- ユーザーAが作成したチャットを、ユーザーBが復元すると、owner_uuidがBに書き換わる
- 所有者情報の不整合

**場所:**
- `ChatSelection.restart_chat()` - 24-25行目
- `ChatSelection.get_chat_tree()` - 39-40行目

#### 3. アクセス権限チェックが実際に動作していない
**問題:**
- `VerifyChatAccess` は定義されているが、どこでも使用されていない
- すべてのチャット操作で権限チェックがバイパスされている

**影響:**
- 他のユーザーのチャットを自由に操作できてしまう
- セキュリティホール

**場所:**
- `ChatInteraction.send_message_and_get_response()` - 権限チェックなし
- `ChatSelection.restart_chat()` - 権限チェックなし
- `ChatSelection.get_chat_tree()` - 権限チェックなし

---

## 今後必要な実装（優先度順）

### 🔥 最優先（Phase 2-A）: データ永続化の修正

#### 1. ChatTreeDetail への owner_uuid 追加
**必要な作業:**
```python
# models.py の修正
class ChatTreeDetail(Model):
    uuid = fields.UUIDField(pk=True)
    owner_uuid = fields.UUIDField()  # 追加
    created = fields.DatetimeField(auto_now_add=True)
    updated = fields.DatetimeField(auto_now=True)
```

**マイグレーション:**
```sql
ALTER TABLE chat_tree_detail
ADD COLUMN owner_uuid UUID NOT NULL;

CREATE INDEX idx_chat_tree_owner ON chat_tree_detail(owner_uuid);
```

#### 2. ChatRepositoryImpl の修正
**`ensure_chat_tree_detail()` の修正:**
```python
async def ensure_chat_tree_detail(self, chat_tree: ChatTreeEntity) -> ChatTreeDetail:
    chat_tree_detail, created = await ChatTreeDetail.get_or_create(
        uuid=chat_tree.uuid,
        defaults={'owner_uuid': chat_tree.owner_uuid}  # 追加
    )
    return chat_tree_detail
```

**新規メソッド追加:**
```python
async def get_chat_tree_info(self, chat_uuid: str) -> dict | None:
    """チャットツリーのメタ情報（owner_uuid含む）を取得"""
    try:
        chat_tree_detail = await ChatTreeDetail.get(uuid=chat_uuid)
        return {
            'uuid': str(chat_tree_detail.uuid),
            'owner_uuid': str(chat_tree_detail.owner_uuid),
            'created': chat_tree_detail.created,
            'updated': chat_tree_detail.updated
        }
    except:
        return None
```

#### 3. ChatSelection の修正
**`restart_chat()` の修正:**
```python
async def restart_chat(self, chat_uuid: str) -> ChatTreeEntity:
    # 1. チャット情報をDBから取得
    chat_info = await self.chat_repository.get_chat_tree_info(chat_uuid)
    if not chat_info:
        raise ValueError(f"Chat tree with ID {chat_uuid} not found")

    # 2. メッセージリスト取得
    message_list = await self.chat_repository.get_chat_tree_messages(chat_uuid, self.user)

    # 3. ツリー復元（正しいowner_uuidで）
    self.chat_tree = ChatTreeEntity.restore_from_message_list(message_list)
    self.chat_tree.uuid = UUID(chat_uuid)
    self.chat_tree.owner_uuid = chat_info['owner_uuid']  # DBから取得した値を使用
    return self.chat_tree
```

**`get_chat_tree()` も同様に修正**

**推定工数:** 2-3時間
**テスト:** 既存の統合テスト（chat_integ.py）で動作確認

---

### 🔴 高優先（Phase 2-B）: アクセス制御の統合

#### 1. ChatInteraction への統合
```python
class ChatInteraction:
    def __init__(
        self,
        message_handler: MessageHandler,
        chat_repository: ChatRepositoryProtcol,
        chat_tree: ChatTreeEntity,
        current_user: UserEntity,
        access_verifier: VerifyChatAccess  # 追加
    ):
        # ...
        self.access_verifier = access_verifier

    async def send_message_and_get_response(
        self, content: str, parent_message: MessageEntity, llm_model: str
    ) -> MessageEntity:
        # 権限チェック追加
        self.access_verifier.verify(self.user, self.chat_tree)

        if not self._can_add_message_to(parent_message):
            raise ValueError(...)
        # 既存処理...
```

#### 2. ChatSelection への統合
```python
async def restart_chat(self, chat_uuid: str) -> ChatTreeEntity:
    chat_info = await self.chat_repository.get_chat_tree_info(chat_uuid)
    # ...

    # 権限チェック追加
    if chat_info['owner_uuid'] != self.user.uuid:
        raise AccessDeniedError(f"User {self.user.uuid} does not own chat {chat_uuid}")

    if not self.user.is_active:
        raise AccessDeniedError(f"User {self.user.uuid} is inactive")

    # 既存処理...
```

**推定工数:** 1-2時間
**テスト:** 権限チェックのユニットテスト追加、統合テストで動作確認

---

### 🟡 中優先（Phase 2-C）: ユーザー管理基盤

#### 1. UserModel の実装
```python
# infrastructure/db/models.py に追加
class UserModel(Model):
    uuid = fields.UUIDField(pk=True)
    username = fields.CharField(max_length=50, unique=True)
    email = fields.CharField(max_length=255, unique=True)
    is_active = fields.BooleanField(default=True)
    created_at = fields.DatetimeField(auto_now_add=True)
    updated_at = fields.DatetimeField(auto_now=True)

    class Meta:
        table = "users"
```

**マイグレーション:**
```sql
CREATE TABLE users (
    uuid UUID PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
```

#### 2. UserRepositoryImpl の実装
```python
# interface_adapters/gateways/user_repository.py 新規作成
class UserRepositoryImpl(UserRepositoryProtocol):
    async def save(self, user: UserEntity) -> None:
        await UserModel.update_or_create(
            uuid=user.uuid,
            defaults={
                'username': user.username,
                'email': user.email,
                'is_active': user.is_active
            }
        )

    async def find_by_uuid(self, uuid: str) -> UserEntity | None:
        try:
            user_model = await UserModel.get(uuid=uuid)
            return UserEntity(
                uuid=str(user_model.uuid),
                username=user_model.username,
                email=user_model.email,
                is_active=user_model.is_active
            )
        except:
            return None

    # find_by_email(), find_by_username() も同様に実装
```

#### 3. ユースケースの実装
- **UserRegistration**: ユーザー登録
- **GetUserProfile**: ユーザー情報取得
- **DeactivateUser**: ユーザー無効化

**推定工数:** 4-5時間
**テスト:** ユーザー管理のユニットテスト、統合テスト

---

### 🟢 低優先（Phase 3以降）

#### Phase 3: パスワード認証
- Value Objects（Email, Username）の実装
- AuthenticationServiceポートの定義
- パスワードハッシュ化の実装（bcrypt等）
- UserAuthenticationユースケース

#### Phase 4: チャット共有機能
- ChatShareEntity の実装
- 共有権限の管理（READ, WRITE, ADMIN）
- AccessControlServiceの拡張

#### Phase 5: 高度な機能
- ロールベースアクセス制御（RBAC）
- 監査ログ
- セッション管理

---

## 技術的負債

### 1. エラーハンドリングの不統一
**問題:**
- 各層で `ValueError`, `Exception` を直接使用
- ドメインエラーとインフラエラーの区別が困難

**提案:**
```python
# domain/exceptions.py 新規作成
class DomainException(Exception):
    """ドメイン層の基底例外"""
    pass

class AccessDeniedError(DomainException):
    pass

class UserNotFoundError(DomainException):
    pass

class ChatNotFoundError(DomainException):
    pass
```

### 2. テストの保守性
**問題:**
- 統合テストで UserEntity を毎回手動で作成
- 実際のユースケースとの乖離

**提案:**
- テスト用のユーザーファクトリを作成
- フィクスチャの活用

### 3. ChatRepositoryProtocol のポート定義の不完全性
**問題:**
- `get_chat_tree_info()` がポートに定義されていない
- Infrastructure層の実装が先行している

**提案:**
```python
# application/ports/output/chat_repository.py に追加
@abstractmethod
async def get_chat_tree_info(self, chat_uuid: str) -> dict | None:
    """チャットツリーのメタ情報（owner_uuid含む）を取得"""
    pass
```

### 4. 非アクティブユーザーのチェック漏れ
**問題:**
- MessageHandler でメッセージ追加時に `is_active` をチェックしていない

**提案:**
- MessageHandlerの各メソッドで非アクティブチェックを追加
- または VerifyChatAccess に統合

---

## アクションプラン

### Week 1: 最優先課題の解決
1. ☐ ChatTreeDetail に owner_uuid 追加（マイグレーション）
2. ☐ ChatRepositoryImpl の修正
3. ☐ ChatSelection の修正
4. ☐ 統合テストで動作確認

### Week 2: セキュリティ強化
1. ☐ ChatInteraction への権限チェック統合
2. ☐ ChatSelection への権限チェック統合
3. ☐ アクセス制御のユニットテスト作成

### Week 3-4: ユーザー管理基盤
1. ☐ UserModel 実装とマイグレーション
2. ☐ UserRepositoryImpl 実装
3. ☐ UserRegistration ユースケース実装
4. ☐ ユーザー管理のテスト

### 以降: 継続的な改善
- パスワード認証の実装
- 技術的負債の解消
- チャット共有機能の検討

---

## 参考資料

### 関連ファイル
- Domain層: `backend/src/domain/entities/`
- Application層: `backend/src/application/use_cases/`
- Infrastructure層: `backend/src/infrastructure/db/models.py`
- テスト: `backend/src/tests/`

### 既存のテストコード
- `backend/src/tests/dev/chat_integ.py` - 統合テスト
- `backend/src/tests/unit/` - ユニットテスト

### マイグレーション
- aerich を使用: `uv run aerich migrate`

---

**最終更新:** 2025-01-15
**作成者:** Claude Code
**ステータス:** Phase 1 完了、Phase 2-A 実装待ち
